<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Diagnostic Pipeline v4.1</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
    }
  </style>
</head>

<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState } = React;

    const Arrow = () => (
      <div className="flex justify-center py-1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2">
          <path d="M12 5v14M5 12l7 7 7-7" />
        </svg>
      </div>
    );

    const ValidationBadge = ({ status }) => {
      const styles = {
        validated: 'bg-green-500/20 text-green-400 border-green-500/50',
        partial: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50',
        unvalidated: 'bg-slate-500/20 text-slate-400 border-slate-500/50',
      };
      const labels = {
        validated: '‚úì Validated',
        partial: '‚óê Partial',
        unvalidated: '‚óã Pending',
      };
      return (
        <span className={`text-xs px-2 py-0.5 rounded border ${styles[status]}`}>
          {labels[status]}
        </span>
      );
    };

    const TypeBadge = ({ type }) => {
      const styles = {
        neural: 'bg-purple-500/20 text-purple-300',
        symbolic: 'bg-green-500/20 text-green-300',
        hybrid: 'bg-blue-500/20 text-blue-300',
      };
      return type ? (
        <span className={`text-xs px-2 py-0.5 rounded ${styles[type]}`}>
          {type.charAt(0).toUpperCase() + type.slice(1)}
        </span>
      ) : null;
    };

    const LLMBadge = ({ enabled }) => {
      return enabled ? (
        <span className="text-xs px-2 py-0.5 rounded bg-gradient-to-r from-pink-500/30 to-purple-500/30 text-pink-300 border border-pink-500/50 animate-pulse">
          ‚ú® LLM
        </span>
      ) : null;
    };

    // Executive View - Simple flow
    const ExecutiveView = () => {
      const stages = [
        { n: '1', title: 'Inputs', desc: 'Vibration + OBD + User NLU (‚ú®LLM semantic extraction)', validation: 'validated', note: 'LLM NLU enabled', llm: true },
        { n: '2', title: 'Evidence Extraction', desc: '18-dim Features + Envelope + Anomaly Detection', validation: 'validated', note: '18-dim + Autoencoder' },
        { n: '2b', title: 'Physics Simulation', desc: 'Chain Mesh + VANOS Burst + Valvetrain Tick', validation: 'validated', note: 'Improved subtle faults' },
        { n: '3', title: 'Knowledge Graph Query', desc: 'Fault KB ‚Üí candidate hypotheses', validation: 'validated', note: 'Unit tests passed' },
        { n: '4', title: 'Deductive Filtering', desc: 'Hard constraints eliminate impossible faults', validation: 'validated', note: '100% Precision' },
        { n: '5', title: 'Abductive Ranking', desc: 'Evidence-Weighted Bayesian Scoring', validation: 'validated', note: 'Recall@3: 84.2%' },
        { n: '6', title: 'Hierarchical Fallback', desc: 'Specific ‚Üí Category ‚Üí System ‚Üí "See mechanic"', validation: 'validated' },
        { n: '7', title: 'Output', desc: 'Diagnosis + ‚ú®LLM Generative Explanation + Actions', validation: 'validated', note: 'LLM Report', llm: true },
      ];

      return (
        <div className="space-y-1">
          {stages.map((s, i) => (
            <div key={i}>
              <div className={`rounded-lg p-3 flex items-center justify-between ${s.llm ? 'bg-gradient-to-r from-slate-800/50 to-pink-900/20 border border-pink-500/30' : 'bg-slate-800/50'}`}>
                <div className="flex items-center gap-3">
                  <span className="bg-slate-700 text-slate-300 text-xs font-bold w-6 h-6 rounded flex items-center justify-center">{s.n}</span>
                  <div>
                    <div className="text-white font-medium text-sm flex items-center gap-2">
                      {s.title}
                      <LLMBadge enabled={s.llm} />
                    </div>
                    <div className="text-slate-400 text-xs">{s.desc}</div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {s.note && <span className={`text-xs ${s.llm ? 'text-pink-400' : 'text-green-400'}`}>{s.note}</span>}
                  <ValidationBadge status={s.validation} />
                </div>
              </div>
              {i < stages.length - 1 && <Arrow />}
            </div>
          ))}
        </div>
      );
    };

    // Pipeline View - Detailed stage breakdown
    const PipelineView = () => {
      const [expanded, setExpanded] = useState(null);

      const stages = [
        {
          n: '1', title: 'Inputs', type: 'hybrid', validation: 'validated', llm: true,
          content: (
            <div className="grid grid-cols-4 gap-2 text-xs">
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2 text-center">
                <div className="text-lg">üì≥</div>
                <div className="text-white font-medium">Vibration</div>
                <div className="text-green-400">Primary</div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center">
                <div className="text-lg">üìä</div>
                <div className="text-white font-medium">OBD-II</div>
                <div className="text-slate-500">Context</div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center opacity-60">
                <div className="text-lg">üé§</div>
                <div className="text-white font-medium">Audio</div>
                <div className="text-red-400">Demoted</div>
              </div>
              <div className="bg-gradient-to-b from-pink-900/30 to-purple-900/30 border border-pink-500/50 rounded p-2 text-center">
                <div className="text-lg">üí¨</div>
                <div className="text-white font-medium">User NLU</div>
                <div className="text-pink-400">‚ú® LLM</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <span className="text-green-400 font-semibold">Vibration Sensor:</span> ADXL1002 MEMS, 50kHz sampling, dual placement (valve cover + oil pan)
              </div>
              <div className="bg-pink-900/20 border border-pink-500/30 rounded p-2">
                <span className="text-pink-400 font-semibold">‚ú® LLM NLU:</span> Semantic extraction of symptoms from fuzzy user text. Supports Korean/English.
                <div className="mt-2 bg-slate-900 rounded p-2 font-mono">
                  <div className="text-slate-500">Input:</div>
                  <div className="text-pink-300">"sounds like marbles in a coffee can when cold"</div>
                  <div className="text-slate-500 mt-1">Output:</div>
                  <div className="text-green-300">{`{ sound_type: "rattle", conditions: { cold_start: 0.9 } }`}</div>
                </div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <span className="text-blue-400 font-semibold">OBD-II Data:</span> Fuel trims (STFT/LTFT), coolant temp, RPM, MAF, O2 sensors, DTCs
              </div>
              <div className="bg-red-900/20 border border-red-500/30 rounded p-2">
                <span className="text-red-400 font-semibold">Audio demoted:</span> AST fusion underperformed single-sensor baseline. Domain gap too large.
              </div>
            </div>
          )
        },
        {
          n: '2', title: 'Evidence Extraction', type: 'hybrid', validation: 'validated',
          content: (
            <div className="space-y-2 text-xs">
              <div className="grid grid-cols-3 gap-2">
                <div className="bg-green-900/30 border border-green-500/50 rounded p-2 text-center">
                  <div className="text-green-400 font-semibold">Vibration</div>
                  <div className="text-slate-400">‚Üí Features</div>
                  <div className="text-slate-400">‚Üí Symptoms</div>
                </div>
                <div className="bg-blue-900/30 border border-blue-500/50 rounded p-2 text-center">
                  <div className="text-blue-400 font-semibold">OBD-II</div>
                  <div className="text-slate-400">‚Üí Fuel Trims</div>
                  <div className="text-slate-400">‚Üí Symptoms</div>
                </div>
                <div className="bg-purple-900/30 border border-purple-500/50 rounded p-2 text-center">
                  <div className="text-purple-400 font-semibold">User NLU</div>
                  <div className="text-slate-400">‚Üí Sound Type</div>
                  <div className="text-slate-400">‚Üí Symptoms</div>
                </div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center">
                <span className="text-yellow-400">All ‚Üí </span>
                <span className="text-cyan-400 font-mono">EvidenceVector</span>
                <span className="text-slate-400"> (unified symptom format for KG)</span>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <div className="text-green-400 font-semibold mb-2">Vibration ‚Üí 18-dim Features ‚Üí Symptoms</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div className="text-slate-500"># 1. Feature Extraction (18-dimensional)</div>
                  <div>signal ‚Üí <span className="text-cyan-300">VibrationFeatures</span> (18-dim)</div>
                  <div className="text-slate-400 ml-4">Time (4): rms, kurtosis, crest_factor, peak_to_peak</div>
                  <div className="text-slate-400 ml-4">Freq (3): dominant_freq, spectral_centroid, bandwidth</div>
                  <div className="text-slate-400 ml-4">Order (5): 0.5x, 1x, 2x, 3x, 4x amplitudes</div>
                  <div className="text-slate-400 ml-4">Envelope (6): env_rms, env_kurtosis, env_0.5x, 1x, 2x, dom_freq</div>
                  <div className="text-slate-500 mt-2"># 2. Anomaly Detection (PhysicsAutoencoder)</div>
                  <div>features ‚Üí trained_model ‚Üí <span className="text-yellow-300">anomaly_score</span></div>
                  <div className="text-slate-400 ml-4">Baseline comparison (per-vehicle Z-score)</div>
                  <div className="text-slate-500 mt-2"># 3. Rule-based Symptom Detection</div>
                  <div>kurtosis &gt; 4.0 ‚Üí <span className="text-green-300">"vib_high_kurtosis"</span></div>
                  <div>env_0.5x elevated ‚Üí <span className="text-green-300">"vib_cam_order_anomaly"</span></div>
                </div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <div className="text-blue-400 font-semibold mb-2">OBD ‚Üí Symptoms (OBDAdapter)</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div>STFT_B1: +12% ‚Üí <span className="text-green-300">"obd_stft_high"</span></div>
                  <div>LTFT_B1: +18% ‚Üí <span className="text-green-300">"obd_ltft_drift"</span></div>
                  <div>DTC P0171 ‚Üí <span className="text-green-300">"dtc_p0171_lean"</span></div>
                </div>
              </div>
              <div className="bg-purple-900/20 border border-purple-500/30 rounded p-2">
                <div className="text-purple-400 font-semibold mb-2">User Text ‚Üí Symptoms (NLU)</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div className="text-pink-300">"Loud knocking worse under load"</div>
                  <div>‚Üí sound_type: <span className="text-green-300">"knock"</span></div>
                  <div>‚Üí condition: <span className="text-green-300">"under_load: 0.9"</span></div>
                </div>
              </div>
            </div>
          )
        },
        {
          n: '2b', title: 'Physics Simulation (Synthetic Data)', type: 'symbolic', validation: 'validated',
          content: (
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2">
                <div className="text-green-400 font-semibold mb-1">VibrationFaultSimulator</div>
                <div className="text-slate-400">FaultType + EngineState</div>
                <div className="text-slate-400">‚Üí signal[51200 samples]</div>
              </div>
              <div className="bg-blue-900/30 border border-blue-500/50 rounded p-2">
                <div className="text-blue-400 font-semibold mb-1">ExtendedOBDSimulator</div>
                <div className="text-slate-400">FaultType + Severity</div>
                <div className="text-slate-400">‚Üí DataFrame[STFT, LTFT, ...]</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <div className="text-green-400 font-semibold mb-2">Vibration Simulator v2.1 - Fault Signatures</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div className="text-slate-500"># Bearing Faults (high amplitude impacts)</div>
                  <div><span className="text-cyan-300">ROD_BEARING</span>: 2x order from TDC impacts</div>
                  <div><span className="text-cyan-300">MAIN_BEARING</span>: 1x order from load reversal</div>
                  <div className="text-slate-500 mt-1"># Subtle Faults (distinctive signatures)</div>
                  <div><span className="text-yellow-300">TIMING_CHAIN</span>: Chain mesh freq (34√ócam_RPM) + AM</div>
                  <div className="text-slate-400 ml-4">‚Üí High-freq harmonics + 0.5x envelope modulation</div>
                  <div><span className="text-yellow-300">VANOS_RATTLE</span>: Hydraulic burst pattern</div>
                  <div className="text-slate-400 ml-4">‚Üí 4-knock bursts at cam transition + rumble</div>
                  <div><span className="text-yellow-300">VALVETRAIN_TICK</span>: Sharp transients at valve events</div>
                  <div className="text-slate-400 ml-4">‚Üí Strong 0.5x, 1x harmonics from tick sharpness</div>
                </div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <div className="text-blue-400 font-semibold mb-2">OBD Simulator ‚Üí Stage 2 Input</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div className="text-slate-500"># Generate synthetic OBD data</div>
                  <div>obd_sim.generate_sample(<span className="text-cyan-300">RUNNING_LEAN</span>, severity=0.7)</div>
                  <div className="text-slate-500 mt-1"># Output: DataFrame with sensor readings</div>
                  <div className="text-yellow-300">{`DataFrame: STFT=+12%, LTFT=+18%, Lambda=1.04`}</div>
                  <div className="text-slate-500 mt-1"># This feeds into Stage 2 (OBDAdapter)</div>
                </div>
              </div>
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Physics Model v2.1 (Improved Subtle Faults):</div>
                <div>‚Ä¢ <span className="text-green-400">Bearing:</span> Impact train ‚Üí resonance ‚Üí orders emerge</div>
                <div>‚Ä¢ <span className="text-yellow-400">Timing Chain:</span> Chain mesh freq + AM envelope</div>
                <div>‚Ä¢ <span className="text-yellow-400">VANOS:</span> Hydraulic burst pattern + cam rumble</div>
                <div>‚Ä¢ <span className="text-yellow-400">Valvetrain:</span> Sharp tick transients ‚Üí 0.5x harmonics</div>
                <div>‚Ä¢ <span className="text-blue-400">Detection:</span> Envelope features capture subtle faults</div>
              </div>
            </div>
          )
        },
        {
          n: '3', title: 'Knowledge Graph Query', type: 'symbolic', validation: 'validated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="flex items-center justify-center gap-2 flex-wrap">
                <span className="bg-yellow-900/50 border border-yellow-500/50 rounded px-2 py-1 text-yellow-300">EvidenceVector</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="bg-cyan-900/50 border border-cyan-500/50 rounded px-2 py-1 text-cyan-300">KG.query(symptoms)</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="bg-green-900/50 border border-green-500/50 rounded px-2 py-1 text-green-300">Fault Candidates</span>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-cyan-900/20 border border-cyan-500/30 rounded p-2">
                <div className="text-cyan-400 font-semibold mb-2">How KG Query Works</div>
                <div className="bg-slate-900 rounded p-2 font-mono text-xs">
                  <div className="text-slate-500"># Input: Symptoms from Stage 2</div>
                  <div className="text-yellow-300">{`evidence.vibration.symptoms = {`}</div>
                  <div className="text-yellow-300 ml-4">{`"vib_high_kurtosis": 0.92,`}</div>
                  <div className="text-yellow-300 ml-4">{`"vib_2x_order_dominant": 0.82`}</div>
                  <div className="text-yellow-300">{`}`}</div>
                  <div className="text-slate-500 mt-2"># KG Lookup: Which faults have these symptoms?</div>
                  <div className="text-green-300">KG["vib_high_kurtosis"] ‚Üí Rod Bearing (0.85), Main Bearing (0.80)</div>
                  <div className="text-green-300">KG["vib_2x_order_dominant"] ‚Üí Rod Bearing (0.90), Piston Slap (0.60)</div>
                  <div className="text-slate-500 mt-2"># Output: Aggregated candidates</div>
                  <div className="text-cyan-300">{`candidates = [ Rod Bearing: 0.87, Main Bearing: 0.40, ... ]`}</div>
                </div>
              </div>
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Ontology Structure:</div>
                <div>‚Ä¢ <span className="text-green-400">13 Faults:</span> Rod Bearing, Main Bearing, VANOS, Timing Chain, Vacuum Leak, etc.</div>
                <div>‚Ä¢ <span className="text-blue-400">59 Symptoms:</span> Sound types, vibration patterns, OBD readings, DTCs</div>
                <div>‚Ä¢ <span className="text-purple-400">98 Edges:</span> Weighted P(Symptom|Fault) relationships</div>
              </div>
              <div className="bg-yellow-900/20 border border-yellow-500/30 rounded p-2">
                <span className="text-yellow-400 font-semibold">Key Insight:</span> Stage 2 outputs <span className="text-cyan-300">symptom IDs</span> (not fault predictions). KG uses symptoms to find matching faults via edge weights.
              </div>
            </div>
          )
        },
        {
          n: '4', title: 'Deductive Filtering', type: 'symbolic', validation: 'validated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="text-green-400 font-semibold mb-1">Hard Constraints (Physics & Logic)</div>
              <div className="grid grid-cols-2 gap-2">
                <div className="text-slate-400">‚Ä¢ Physics: RPM, Temp, Load, Onset</div>
                <div className="text-slate-400">‚Ä¢ System: Fuel Trims, DTC Logic</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Hard Constraints (Eliminate Impossible):</div>
                <div>‚Ä¢ <span className="text-red-400">DTC Logic:</span> P0171 (lean) ‚Üí eliminates "Running Rich"</div>
                <div>‚Ä¢ <span className="text-red-400">Physics:</span> Cold start only ‚Üí eliminates heat-related faults</div>
                <div>‚Ä¢ <span className="text-red-400">Onset:</span> Sudden onset ‚Üí eliminates wear-related faults</div>
              </div>
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Soft Constraints (Adjust Confidence):</div>
                <div>‚Ä¢ <span className="text-yellow-400">Mileage:</span> High mileage ‚Üí boost bearing/chain wear</div>
                <div>‚Ä¢ <span className="text-yellow-400">Fuel Trims:</span> LTFT deviation ‚Üí boost fuel system faults</div>
              </div>
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <span className="text-green-400 font-semibold">Safety Floor:</span> Never eliminate all candidates. Always keep at least one hypothesis.
              </div>
            </div>
          )
        },
        {
          n: '5', title: 'Abductive Ranking', type: 'hybrid', validation: 'validated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="text-blue-400 font-semibold mb-1">Bayesian Logic + Reasoning</div>
              <div className="space-y-1">
                {[
                  { fault: 'Rod knock', score: '0.85', top: true },
                  { fault: 'Main bearing', score: '0.12', top: false },
                ].map((h, i) => (
                  <div key={i} className={`flex justify-between p-1 rounded ${h.top ? 'bg-blue-900/30' : 'bg-slate-900'}`}>
                    <span className={h.top ? 'text-white' : 'text-slate-400'}>{h.fault}</span>
                    <span className={h.top ? 'text-blue-300' : 'text-slate-500'}>{h.score}</span>
                  </div>
                ))}
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Bayesian Scoring Formula:</div>
                <div className="font-mono text-blue-300 text-center py-1">P(Fault|Evidence) ‚àù P(Evidence|Fault) √ó P(Fault)</div>
                <div className="mt-1">‚Ä¢ Evidence weights based on diagnostic importance</div>
                <div>‚Ä¢ Missing evidence penalizes confidence</div>
                <div>‚Ä¢ Contradictory evidence heavily penalizes</div>
              </div>
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Example Scoring:</div>
                <div className="grid grid-cols-2 gap-2 mt-1">
                  <div className="bg-blue-900/30 rounded p-1">
                    <div className="text-blue-300">Rod Bearing</div>
                    <div className="text-slate-400 text-xs">+0.3 knock, +0.2 under_load, +0.15 2x_order</div>
                    <div className="text-green-400">= 0.65</div>
                  </div>
                  <div className="bg-slate-800 rounded p-1">
                    <div className="text-slate-400">Main Bearing</div>
                    <div className="text-slate-500 text-xs">+0.3 knock, +0.1 under_load, -0.1 missing_1x</div>
                    <div className="text-slate-400">= 0.30</div>
                  </div>
                </div>
              </div>
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <span className="text-green-400 font-semibold">E2E Result:</span> 84.2% Recall@3 (16/19 test scenarios)
              </div>
            </div>
          )
        },
        {
          n: '6', title: 'Hierarchical Fallback', type: 'symbolic', validation: 'validated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="flex items-center gap-2 justify-center flex-wrap">
                <span className="text-green-400 bg-green-900/30 px-2 py-1 rounded">rod_bearing</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-yellow-400 bg-yellow-900/30 px-2 py-1 rounded">bottom_end_issue</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-orange-400 bg-orange-900/30 px-2 py-1 rounded">engine_mechanical</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-red-400 bg-red-900/30 px-2 py-1 rounded">see_mechanic</span>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Confidence-Based Fallback:</div>
                <div>‚Ä¢ <span className="text-green-400">&gt;60%</span> ‚Üí Specific fault diagnosis</div>
                <div>‚Ä¢ <span className="text-yellow-400">40-60%</span> ‚Üí Category-level ("Bottom-end issue suspected")</div>
                <div>‚Ä¢ <span className="text-orange-400">20-40%</span> ‚Üí System-level ("Engine mechanical problem")</div>
                <div>‚Ä¢ <span className="text-red-400">&lt;20%</span> ‚Üí Generic ("Professional inspection recommended")</div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <span className="text-blue-400 font-semibold">Purpose:</span> Always provide actionable guidance, even with insufficient evidence.
              </div>
            </div>
          )
        },
        {
          n: '7', title: 'Output', type: 'hybrid', validation: 'validated', llm: true,
          content: (
            <div className="bg-gradient-to-r from-slate-800 via-slate-900 to-pink-900/20 rounded p-3 border border-pink-500/50 text-xs">
              <div className="flex justify-between items-center mb-2">
                <span className="text-white font-bold">üîß Rod Bearing Wear</span>
                <div className="flex items-center gap-2">
                  <span className="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">72%</span>
                  <span className="text-pink-400 text-xs">‚ú® LLM</span>
                </div>
              </div>
              <div className="grid grid-cols-2 gap-2 text-slate-300 mb-2">
                <div><span className="text-green-400">‚úì</span> Vibration: 2x order dominant</div>
                <div><span className="text-green-400">‚úì</span> High kurtosis (impulsive)</div>
              </div>
              <div className="bg-pink-900/20 border border-pink-500/30 rounded p-2 text-pink-200 italic">
                "The knocking you described, worse under load, combined with the 2x crankshaft order harmonics, indicates rod bearing clearance..."
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-pink-900/20 border border-pink-500/30 rounded p-2">
                <span className="text-pink-400 font-semibold">‚ú® LLM Generative Report:</span> Transforms Bayesian reasoning paths into human-readable explanations. Context-aware (references user's words), multi-language (EN/KO), suggests next diagnostic steps.
              </div>
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Output Components:</div>
                <div>‚Ä¢ <span className="text-green-400">Diagnosis:</span> Fault name + confidence %</div>
                <div>‚Ä¢ <span className="text-pink-400">Explanation:</span> LLM-generated reasoning narrative</div>
                <div>‚Ä¢ <span className="text-blue-400">Actions:</span> Prioritized verification steps</div>
                <div>‚Ä¢ <span className="text-yellow-400">Urgency:</span> Immediate / Soon / Schedule / Monitor</div>
              </div>
            </div>
          )
        },
      ];

      return (
        <div className="space-y-2">
          {stages.map((s, i) => (
            <div key={i}>
              <div className={`rounded-lg border overflow-hidden ${s.llm ? 'bg-gradient-to-r from-slate-900/50 to-pink-900/10 border-pink-500/30' : 'bg-slate-900/50 border-slate-700'}`}>
                <div className="p-3">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <span className="bg-slate-700 text-slate-300 text-xs font-bold w-6 h-6 rounded flex items-center justify-center">{s.n}</span>
                      <span className="text-blue-400 text-sm font-semibold">{s.title}</span>
                      <LLMBadge enabled={s.llm} />
                    </div>
                    <div className="flex items-center gap-2">
                      <TypeBadge type={s.type} />
                      <ValidationBadge status={s.validation} />
                    </div>
                  </div>
                  {s.content}
                </div>
                {s.details && (
                  <>
                    <button
                      onClick={() => setExpanded(expanded === i ? null : i)}
                      className="w-full px-3 py-1.5 bg-slate-800/50 border-t border-slate-700 flex items-center justify-between text-xs text-slate-500 hover:bg-slate-800"
                    >
                      <span>Details</span>
                      <span>{expanded === i ? '‚àí' : '+'}</span>
                    </button>
                    {expanded === i && (
                      <div className="px-3 py-2 bg-slate-800/30 border-t border-slate-700">
                        {s.details}
                      </div>
                    )}
                  </>
                )}
              </div>
              {i < stages.length - 1 && <Arrow />}
            </div>
          ))}
        </div>
      );
    };

    // Data Flow View - Shows transformation from synthetic data to KG query
    const DataFlowView = () => {
      return (
        <div className="space-y-3 text-xs">
          <div className="text-center text-slate-400 mb-4">
            How synthetic data flows through the pipeline to KG query
          </div>

          {/* Stage 2b: Simulators */}
          <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
            <div className="text-purple-400 font-bold mb-2">Stage 2b: Physics Simulators (Generate Synthetic Data)</div>
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <div className="text-green-400 font-semibold">VibrationFaultSimulator</div>
                <div className="font-mono mt-1 text-slate-400">
                  <div>Input: <span className="text-cyan-300">ROD_BEARING_MID</span></div>
                  <div className="ml-4">+ EngineState(rpm=2500, load=50%)</div>
                  <div className="mt-1">Output: <span className="text-yellow-300">signal[102400 floats]</span></div>
                  <div className="ml-4 text-slate-500">Physics: Impact train ‚Üí resonance ‚Üí 2x order emerges</div>
                </div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <div className="text-blue-400 font-semibold">ExtendedOBDSimulator</div>
                <div className="font-mono mt-1 text-slate-400">
                  <div>Input: <span className="text-cyan-300">RUNNING_LEAN</span>, severity=0.7</div>
                  <div className="mt-1">Output: <span className="text-yellow-300">DataFrame[100 rows]</span></div>
                  <div className="ml-4 text-slate-500">Cols: STFT, LTFT, Lambda, RPM, MAP...</div>
                </div>
              </div>
            </div>
          </div>

          <div className="flex justify-center"><svg width="16" height="24" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7" /></svg></div>

          {/* Stage 2: Feature Extraction */}
          <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
            <div className="text-green-400 font-bold mb-2">Stage 2: Evidence Extraction (Raw ‚Üí Features ‚Üí Symptoms)</div>
            <div className="grid grid-cols-2 gap-3">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <div className="text-green-400 font-semibold">VibrationAdapter.convert() - 18-dim Features</div>
                <div className="font-mono mt-1 text-slate-400">
                  <div className="text-slate-500"># Step 1: 18-Dimensional Feature Extraction</div>
                  <div>signal ‚Üí <span className="text-cyan-300">VibrationFeatures</span></div>
                  <div className="ml-4">Time(4): rms, kurtosis, crest, peak_to_peak</div>
                  <div className="ml-4">Freq(3): dom_freq, centroid, bandwidth</div>
                  <div className="ml-4">Order(5): <span className="text-yellow-300">0.5x, 1x, 2x, 3x, 4x</span></div>
                  <div className="ml-4">Envelope(6): <span className="text-purple-300">env_rms, kurtosis, 0.5x, 1x, 2x, dom</span></div>
                  <div className="text-slate-500 mt-2"># Step 2: Anomaly Detection</div>
                  <div>features ‚Üí <span className="text-purple-300">PhysicsAutoencoder</span> ‚Üí anomaly_score</div>
                  <div className="ml-4">Trained on normal data only</div>
                  <div className="text-slate-500 mt-2"># Step 3: Symptom Detection</div>
                  <div>kurtosis &gt; 4.0 ‚Üí <span className="text-green-300">"vib_high_kurtosis"</span></div>
                  <div>env_0.5x elevated ‚Üí <span className="text-green-300">"vib_cam_order_anomaly"</span></div>
                </div>
              </div>
              <div className="bg-blue-900/20 border border-blue-500/30 rounded p-2">
                <div className="text-blue-400 font-semibold">OBDAdapter.convert()</div>
                <div className="font-mono mt-1 text-slate-400">
                  <div className="text-slate-500"># Step 1: Extract values</div>
                  <div>DataFrame ‚Üí mean(STFT): <span className="text-yellow-300">+12%</span></div>
                  <div className="ml-4">mean(LTFT): <span className="text-yellow-300">+18%</span></div>
                  <div className="ml-4">mean(Lambda): <span className="text-yellow-300">1.04</span></div>
                  <div className="text-slate-500 mt-2"># Step 2: Threshold Detection</div>
                  <div>STFT &gt; 10% ‚Üí <span className="text-green-300">"obd_stft_high"</span></div>
                  <div>Lambda &gt; 1.03 ‚Üí <span className="text-green-300">"obd_lean"</span></div>
                  <div className="text-slate-500 mt-2"># Step 3: DTC Mapping</div>
                  <div>P0171 ‚Üí <span className="text-green-300">"dtc_p0171_lean_b1"</span></div>
                </div>
              </div>
            </div>
          </div>

          <div className="flex justify-center"><svg width="16" height="24" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7" /></svg></div>

          {/* EvidenceVector */}
          <div className="bg-yellow-900/20 rounded-lg p-3 border border-yellow-500/50">
            <div className="text-yellow-400 font-bold mb-2">EvidenceVector (Unified Format)</div>
            <div className="font-mono bg-slate-900 rounded p-2 text-slate-400">
              <div>{`EvidenceVector {`}</div>
              <div className="ml-2 text-green-300">{`vibration: { symptoms: ["vib_high_kurtosis", "vib_2x_order_dominant", "sound_knock_rod"] }`}</div>
              <div className="ml-2 text-blue-300">{`obd: { symptoms: ["obd_stft_high", "obd_lean"], dtcs: ["P0171"] }`}</div>
              <div className="ml-2 text-purple-300">{`user: { symptoms: ["sound_knock", "condition_under_load"] }`}</div>
              <div>{`}`}</div>
            </div>
          </div>

          <div className="flex justify-center"><svg width="16" height="24" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7" /></svg></div>

          {/* Stage 3: KG Query */}
          <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
            <div className="text-cyan-400 font-bold mb-2">Stage 3: Knowledge Graph Query</div>
            <div className="font-mono bg-cyan-900/20 border border-cyan-500/30 rounded p-2 text-slate-400">
              <div className="text-slate-500"># For each symptom, find faults that exhibit it</div>
              <div className="mt-1">KG.query(<span className="text-green-300">"vib_high_kurtosis"</span>)</div>
              <div className="ml-2">‚Üí Rod Bearing <span className="text-yellow-300">(0.85)</span>, Main Bearing <span className="text-yellow-300">(0.80)</span></div>
              <div className="mt-1">KG.query(<span className="text-green-300">"vib_2x_order_dominant"</span>)</div>
              <div className="ml-2">‚Üí Rod Bearing <span className="text-yellow-300">(0.90)</span>, Piston Slap <span className="text-yellow-300">(0.60)</span></div>
              <div className="mt-1">KG.query(<span className="text-green-300">"sound_knock_rod"</span>)</div>
              <div className="ml-2">‚Üí Rod Bearing <span className="text-yellow-300">(0.95)</span>, Main Bearing <span className="text-yellow-300">(0.70)</span></div>
              <div className="text-slate-500 mt-2"># Aggregate scores</div>
              <div className="text-cyan-300">candidates = [Rod Bearing: 0.90, Main Bearing: 0.50, Piston Slap: 0.30, ...]</div>
            </div>
          </div>

          <div className="flex justify-center"><svg width="16" height="24" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2"><path d="M12 5v14M5 12l7 7 7-7" /></svg></div>

          {/* Stages 4-5 */}
          <div className="bg-slate-900 rounded-lg p-3 border border-slate-700">
            <div className="text-blue-400 font-bold mb-2">Stages 4-5: Deductive Filtering ‚Üí Abductive Ranking</div>
            <div className="font-mono text-slate-400">
              <div>candidates ‚Üí <span className="text-red-400">eliminate impossible</span> ‚Üí <span className="text-blue-400">Bayesian scoring</span></div>
              <div className="mt-1 text-green-300">Final: Rod Bearing Failure (85% confidence)</div>
            </div>
          </div>

          {/* Key Insight */}
          <div className="bg-gradient-to-r from-purple-900/30 to-pink-900/30 rounded-lg p-3 border border-purple-500/50 mt-4">
            <div className="text-purple-300 font-bold">Key Insight</div>
            <div className="text-slate-300 mt-1">
              The transformation chain is: <span className="text-cyan-300">Raw Signal</span> ‚Üí <span className="text-green-300">18-dim Features</span> ‚Üí <span className="text-purple-300">Anomaly Score</span> ‚Üí <span className="text-yellow-300">Symptom IDs</span> ‚Üí <span className="text-blue-300">KG Query</span>
            </div>
            <div className="text-slate-400 mt-1">
              <strong>Envelope features</strong> (via Hilbert transform) capture amplitude modulation from timing chain mesh, VANOS hydraulic bursts, and valvetrain ticks.
              <strong>PhysicsAutoencoder</strong> trained on normal data detects deviations without labeled fault data.
            </div>
          </div>

          {/* Multi-Modal Evidence Insight */}
          <div className="bg-gradient-to-r from-blue-900/30 to-cyan-900/30 rounded-lg p-3 border border-cyan-500/50 mt-3">
            <div className="text-cyan-300 font-bold">Why Multi-Modal Matters</div>
            <div className="text-slate-300 mt-1">
              <strong>Not all faults show in vibration!</strong> The system uses <span className="text-yellow-300">ALL evidence sources</span>:
            </div>
            <div className="mt-2 grid grid-cols-2 gap-2 text-xs">
              <div className="bg-slate-900/50 rounded p-2">
                <div className="text-green-400 font-semibold">Vibration Detects:</div>
                <div className="text-slate-400">‚Ä¢ Rod/Main Bearing</div>
                <div className="text-slate-400">‚Ä¢ Timing Chain</div>
                <div className="text-slate-400">‚Ä¢ VANOS/Valvetrain</div>
              </div>
              <div className="bg-slate-900/50 rounded p-2">
                <div className="text-blue-400 font-semibold">OBD/DTC Detects:</div>
                <div className="text-slate-400">‚Ä¢ Boost Leak (P0299)</div>
                <div className="text-slate-400">‚Ä¢ Vacuum Leak (P0171)</div>
                <div className="text-slate-400">‚Ä¢ Misfire (P0300)</div>
              </div>
            </div>
            <div className="text-slate-400 mt-2 text-xs">
              Example: Boost leak has <span className="text-green-300">NORMAL vibration</span> but is detected via <span className="text-blue-300">DTCs + fuel trims + user "whooshing sound"</span>.
              The KG combines ALL symptoms to find the best explanation.
            </div>
          </div>
        </div>
      );
    };

    // Research Log
    const ResearchLog = () => {
      const items = [
        { stage: '1', q: 'Accelerometer placement: engine block vs. chassis vs. multiple?', status: 'resolved', answer: 'Dual: valve cover + oil pan' },
        { stage: '1', q: 'Sampling rate: 10kHz or 50kHz?', status: 'resolved', answer: '50kHz for bearing faults' },
        { stage: '1', q: 'Audio value-add vs. vibration alone?', status: 'resolved', answer: 'Minimal. AST underperformed. Demoted.' },
        { stage: '2', q: 'WSST vs WST vs FFT?', status: 'resolved', answer: 'FFT sufficient for stable RPM (85.6%). WSST for variable.' },
        { stage: '2', q: 'Best feature type for vibration?', status: 'resolved', answer: 'Mel-spectrogram > MFCC > classical FFT' },
        { stage: '2', q: 'Best classifier for MAFAULDA?', status: 'resolved', answer: 'MLP (98.72%) ‚âà SVM > RF > LR' },
        { stage: '2', q: 'Sensor fusion value?', status: 'resolved', answer: 'Only +0.25% gain. Not worth complexity.' },
        { stage: '2', q: 'Paderborn AST embeddings?', status: 'resolved', answer: 'Poor clustering. Domain gap too large.' },
        { stage: '2b', q: 'OBD simulation realistic?', status: 'resolved', answer: 'Improved sim: 42.5% direct (was 36.6%)' },
        { stage: '2b', q: 'Synthetic fault signatures valid?', status: 'resolved', answer: 'Confusion patterns match real data' },
        { stage: '2b', q: 'Best sim-to-real recipe?', status: 'resolved', answer: 'CORAL + 10% real ‚Üí 68.4% (83% gap closed)' },
        { stage: '2b', q: 'Temporal structure important?', status: 'resolved', answer: 'Yes. AR(1) autocorr 0.09‚Üí0.91 critical' },
        { stage: '2b', q: 'F2‚ÜîF3 confusion fixable?', status: 'resolved', answer: 'No. Fundamental limit (~50% even Real‚ÜíReal). Same fault, different conditions.' },
        { stage: '2', q: 'Feature dimensionality?', status: 'resolved', answer: '18-dim: 4 time + 3 freq + 5 order + 6 envelope' },
        { stage: '2', q: 'Envelope features for subtle faults?', status: 'resolved', answer: 'Yes. Hilbert transform captures AM from chain/VANOS/valvetrain' },
        { stage: '2', q: 'Anomaly detection approach?', status: 'resolved', answer: 'PhysicsAutoencoder trained on normal + per-vehicle baseline Z-score' },
        { stage: '2b', q: 'Timing chain simulation?', status: 'resolved', answer: 'Chain mesh freq (34√ócam_RPM) + AM envelope at 0.5x' },
        { stage: '2b', q: 'VANOS rattle simulation?', status: 'resolved', answer: 'Hydraulic burst pattern (4-knock) + cam rumble tone' },
        { stage: '2b', q: 'Valvetrain tick simulation?', status: 'resolved', answer: 'Sharp transients ‚Üí strong 0.5x harmonics' },
        { stage: '2', q: 'Why multi-modal (not just vibration)?', status: 'resolved', answer: 'Not all faults show in vibration! Boost/vacuum leak, misfire detected via OBD+DTCs+user NLU' },
        { stage: '2', q: 'Fusion weighting: static or learned attention?', status: 'open', answer: null },
        { stage: '3', q: 'Graph storage: Neo4j vs in-memory?', status: 'resolved', answer: 'In-memory Python classes. (Sufficient for <100 nodes)' },
        { stage: '3', q: 'KG population: manual vs LLM extraction?', status: 'resolved', answer: 'Manual ontology (high precision defined in code, extensible per vehicle)' },
        { stage: '3', q: 'Does KG cover ALL faults?', status: 'resolved', answer: 'Extensible design. Core covers critical faults (80% impact). New vehicles/faults added via ontology expansion.' },
        { stage: '2b', q: 'Sim v2.0: Do orders emerge from physics?', status: 'resolved', answer: 'Yes. Rod=2x, Main=1x naturally (0.4% error)' },
        { stage: '2b', q: 'Sim v2.0: Sensor differentiation?', status: 'resolved', answer: 'Validated. Transfer functions isolate blocks.' },
        { stage: '3', q: 'Evidence Schema defined?', status: 'resolved', answer: 'Yes. core/evidence_schema.py completed.' },
        { stage: '5', q: 'Reference Logic', status: 'resolved', answer: 'Evidence-Weighted Bayesian Scoring implemented.' },
        { stage: '2', q: 'Industrial AI Integration?', status: 'resolved', answer: 'Adopted TFI (STFT Imaging) & Autoencoders.' },
        { stage: '5', q: 'E2E Accuracy?', status: 'resolved', answer: '84.2% Recall@3 achieved.' },
        { stage: '1', q: 'LLM for User NLU?', status: 'resolved', answer: 'Yes. Semantic mapping of fuzzy text ‚Üí KG ontology. Handles metaphors ("marbles in can" ‚Üí rattle).' },
        { stage: '4', q: 'LLM for Deductive Filtering?', status: 'resolved', answer: 'NO. Safety-critical. Must be 100% deterministic. LLMs can hallucinate.' },
        { stage: '7', q: 'LLM for Explanation?', status: 'resolved', answer: 'Yes. Generative reports from Bayesian paths. Context-aware, multi-language.' },
        { stage: '1-7', q: 'Where does LLM fit in Neuro-Symbolic?', status: 'resolved', answer: 'Boundaries only: Input (NLU) + Output (Report). Core reasoning (3-6) stays symbolic.' },
      ];

      return (
        <div className="space-y-2">
          {items.map((item, i) => (
            <div key={i} className={`rounded p-2 text-xs ${item.status === 'resolved' ? 'bg-green-900/20 border border-green-500/30' : 'bg-slate-800'}`}>
              <div className="flex items-start gap-2">
                <span className="bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded text-xs">S{item.stage}</span>
                <div className="flex-1">
                  <div className={item.status === 'resolved' ? 'text-slate-400 line-through' : 'text-slate-300'}>{item.q}</div>
                  {item.answer && <div className="text-green-400 mt-1">‚Üí {item.answer}</div>}
                </div>
                <span className={`px-1.5 py-0.5 rounded text-xs ${item.status === 'resolved' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                  {item.status}
                </span>
              </div>
            </div>
          ))}
        </div>
      );
    };

    function App() {
      const [view, setView] = useState('executive');

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-950 to-slate-900 p-4">
          <h1 className="text-xl font-bold text-center mb-1 bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 bg-clip-text text-transparent">
            Vehicle Diagnostic Pipeline v4.1
          </h1>
          <p className="text-center text-slate-500 text-xs mb-4">Neuro-Symbolic Reasoning + <span className="text-pink-400">‚ú® LLM Integration</span> ‚Ä¢ <span className="text-blue-400">General Vehicle Diagnostic System</span></p>

          {/* View Toggle */}
          <div className="flex justify-center gap-1 mb-4 flex-wrap">
            {[
              { key: 'executive', label: 'Overview' },
              { key: 'pipeline', label: 'Pipeline' },
              { key: 'dataflow', label: 'Data Flow' },
              { key: 'research', label: 'Research Log' }
            ].map(v => (
              <button
                key={v.key}
                onClick={() => setView(v.key)}
                className={`px-3 py-1 rounded text-xs font-medium transition ${view === v.key ? 'bg-blue-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                  }`}
              >
                {v.label}
              </button>
            ))}
          </div>

          {/* Validation Summary */}
          <div className="max-w-3xl mx-auto mb-4 flex justify-center gap-4 text-xs">
            <div className="flex items-center gap-1">
              <span className="text-green-400">‚óè</span>
              <span className="text-slate-400">8/8 validated</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="text-slate-400">‚óè</span>
              <span className="text-slate-400">0/8 pending</span>
            </div>
          </div>

          <div className="max-w-3xl mx-auto">
            {view === 'executive' && <ExecutiveView />}
            {view === 'pipeline' && <PipelineView />}
            {view === 'dataflow' && <DataFlowView />}
            {view === 'research' && <ResearchLog />}
          </div>

          {/* Compact Legend */}
          <div className="max-w-3xl mx-auto mt-4 pt-3 border-t border-slate-800 flex justify-center gap-4 text-xs text-slate-500">
            <span><span className="text-purple-400">‚ñ†</span> Neural</span>
            <span><span className="text-green-400">‚ñ†</span> Symbolic</span>
            <span><span className="text-blue-400">‚ñ†</span> Hybrid</span>
            <span><span className="text-pink-400">‚ú®</span> LLM</span>
          </div>

          <div className="text-center text-xs text-slate-600 mt-3">
            v4.1 ‚Äî 18-dim Features | Envelope Analysis | PhysicsAutoencoder | Improved Subtle Fault Simulation
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>

</html>
