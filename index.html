<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vehicle Diagnostic Pipeline v3.3</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>body { margin: 0; }</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState } = React;

    const Arrow = () => (
      <div className="flex justify-center py-1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#475569" strokeWidth="2">
          <path d="M12 5v14M5 12l7 7 7-7"/>
        </svg>
      </div>
    );

    const ValidationBadge = ({ status }) => {
      const styles = {
        validated: 'bg-green-500/20 text-green-400 border-green-500/50',
        partial: 'bg-yellow-500/20 text-yellow-400 border-yellow-500/50',
        unvalidated: 'bg-slate-500/20 text-slate-400 border-slate-500/50',
      };
      const labels = {
        validated: '‚úì Validated',
        partial: '‚óê Partial',
        unvalidated: '‚óã Pending',
      };
      return (
        <span className={`text-xs px-2 py-0.5 rounded border ${styles[status]}`}>
          {labels[status]}
        </span>
      );
    };

    const TypeBadge = ({ type }) => {
      const styles = {
        neural: 'bg-purple-500/20 text-purple-300',
        symbolic: 'bg-green-500/20 text-green-300',
        hybrid: 'bg-blue-500/20 text-blue-300',
      };
      return type ? (
        <span className={`text-xs px-2 py-0.5 rounded ${styles[type]}`}>
          {type.charAt(0).toUpperCase() + type.slice(1)}
        </span>
      ) : null;
    };

    // Executive View - Simple flow
    const ExecutiveView = () => {
      const stages = [
        { n: '1', title: 'Inputs', desc: 'Vibration + OBD + Audio + User symptoms', validation: 'validated', note: 'Sensor spec done' },
        { n: '2', title: 'Evidence Extraction', desc: 'FFT/Mel-spec features ‚Üí CNN encoder', validation: 'validated', note: 'MAFAULDA: 98.7%' },
        { n: '2b', title: 'OBD Simulation', desc: 'Synthetic N55 faults validated vs real data', validation: 'validated', note: 'vs EngineFaultDB: Œî5%' },
        { n: '3', title: 'Knowledge Graph Query', desc: 'Fault KB ‚Üí candidate hypotheses', validation: 'unvalidated' },
        { n: '4', title: 'Deductive Filtering', desc: 'Hard constraints eliminate impossible faults', validation: 'unvalidated' },
        { n: '5', title: 'Abductive Ranking', desc: 'LLM + RAG ranks by evidence coverage', validation: 'unvalidated' },
        { n: '6', title: 'Hierarchical Fallback', desc: 'Specific ‚Üí Category ‚Üí System ‚Üí "See mechanic"', validation: 'unvalidated' },
        { n: '7', title: 'Output', desc: 'Diagnosis + confidence + reasoning + action', validation: 'unvalidated' },
      ];

      return (
        <div className="space-y-1">
          {stages.map((s, i) => (
            <div key={i}>
              <div className="bg-slate-800/50 rounded-lg p-3 flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <span className="bg-slate-700 text-slate-300 text-xs font-bold w-6 h-6 rounded flex items-center justify-center">{s.n}</span>
                  <div>
                    <div className="text-white font-medium text-sm">{s.title}</div>
                    <div className="text-slate-400 text-xs">{s.desc}</div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {s.note && <span className="text-green-400 text-xs">{s.note}</span>}
                  <ValidationBadge status={s.validation} />
                </div>
              </div>
              {i < stages.length - 1 && <Arrow />}
            </div>
          ))}
        </div>
      );
    };

    // Engineering View - Detailed
    const EngineeringView = () => {
      const [expanded, setExpanded] = useState(null);

      const stages = [
        {
          n: '1', title: 'Inputs', type: null, validation: 'validated',
          content: (
            <div className="grid grid-cols-4 gap-2 text-xs">
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2 text-center">
                <div className="text-lg">üì≥</div>
                <div className="text-white font-medium">Vibration</div>
                <div className="text-green-400">Primary</div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center">
                <div className="text-lg">üìä</div>
                <div className="text-white font-medium">OBD-II</div>
                <div className="text-slate-500">Context</div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center opacity-60">
                <div className="text-lg">üé§</div>
                <div className="text-white font-medium">Audio</div>
                <div className="text-red-400">Demoted</div>
              </div>
              <div className="bg-slate-800 rounded p-2 text-center">
                <div className="text-lg">üí¨</div>
                <div className="text-white font-medium">User</div>
                <div className="text-slate-500">Symptoms</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <span className="text-green-400 font-semibold">Sensor spec:</span> ADXL1002 MEMS, 50kHz, dual placement (valve cover + oil pan)
              </div>
              <div className="bg-red-900/20 border border-red-500/30 rounded p-2">
                <span className="text-red-400 font-semibold">Audio demoted:</span> AST fusion underperformed single-sensor baseline. Domain gap too large.
              </div>
            </div>
          )
        },
        {
          n: '2', title: 'Evidence Extraction', type: 'hybrid', validation: 'validated',
          content: (
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2">
                <div className="text-green-400 font-semibold mb-1">Vibration ‚Üí FFT/Mel-spec</div>
                <div className="text-slate-400">Stable RPM: FFT sufficient (85.6%)</div>
                <div className="text-slate-400">Variable RPM: WSST if needed</div>
              </div>
              <div className="bg-purple-900/30 border border-purple-500/50 rounded p-2">
                <div className="text-purple-400 font-semibold mb-1">Classifier</div>
                <div className="text-slate-400">MLP or SVM</div>
                <div className="text-green-400">MAFAULDA: 98.72%</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">MAFAULDA Sweep Results (72 configs):</div>
                <div>‚Ä¢ Single sensor (col2) + mel-spec + MLP ‚Üí <span className="text-green-400">98.72%</span></div>
                <div>‚Ä¢ Dual sensor fusion only +0.25% gain ‚Äî not worth complexity</div>
                <div>‚Ä¢ AST foundation model: <span className="text-red-400">failed</span> (domain gap)</div>
              </div>
              <div className="bg-yellow-900/20 border border-yellow-500/30 rounded p-2">
                <span className="text-yellow-400 font-semibold">Gap:</span> "Normal" class is bottleneck. Fusion adds noise for healthy samples.
              </div>
            </div>
          )
        },
        {
          n: '2b', title: 'OBD Simulation', type: 'symbolic', validation: 'validated',
          content: (
            <div className="grid grid-cols-2 gap-2 text-xs">
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2">
                <div className="text-green-400 font-semibold mb-1">N55 Synthetic Generator</div>
                <div className="text-slate-400">Misfire, Vacuum Leak, O2 Degradation</div>
                <div className="text-slate-400">Vehicle-to-vehicle variation ¬±4%</div>
              </div>
              <div className="bg-green-900/30 border border-green-500/50 rounded p-2">
                <div className="text-green-400 font-semibold mb-1">Validated vs EngineFaultDB</div>
                <div className="text-slate-400">Synthetic: 69.6% | Real: 74.1%</div>
                <div className="text-green-400">Gap: only 4.5%</div>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Validation Results:</div>
                <div>‚Ä¢ Compared to IEEE peer-reviewed EngineFaultDB (55,999 samples)</div>
                <div>‚Ä¢ Confusion patterns match (healthy‚Üîmisfire, F2‚ÜîF3)</div>
                <div>‚Ä¢ Within published benchmarks (70-85% for multi-fault)</div>
              </div>
              <div className="bg-green-900/20 border border-green-500/30 rounded p-2">
                <span className="text-green-400 font-semibold">Status:</span> Synthetic OBD data validated as realistic for ML training
              </div>
            </div>
          )
        },
        {
          n: '3', title: 'Knowledge Graph Query', type: 'symbolic', validation: 'unvalidated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="flex items-center justify-center gap-2 flex-wrap">
                <span className="bg-blue-900/50 border border-blue-500/50 rounded px-2 py-1 text-blue-300">evidence</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="bg-yellow-900/50 border border-yellow-500/50 rounded px-2 py-1 text-yellow-300">symptom</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="bg-green-900/50 border border-green-500/50 rounded px-2 py-1 text-green-300">fault candidates</span>
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Graph Schema:</div>
                <div className="flex flex-wrap gap-1">
                  {['Component', 'System', 'Symptom', 'Fault', 'Evidence', 'Procedure'].map(n => (
                    <span key={n} className="bg-slate-700 px-1.5 py-0.5 rounded text-xs">{n}</span>
                  ))}
                </div>
              </div>
              <div className="text-slate-500">Storage: Neo4j or in-memory for edge. GNN deferred to scale phase.</div>
            </div>
          )
        },
        {
          n: '4', title: 'Deductive Filtering', type: 'symbolic', validation: 'unvalidated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="text-green-400 font-semibold mb-1">Hard Constraints (cannot override)</div>
              <div className="grid grid-cols-2 gap-2">
                <div className="text-slate-400">‚Ä¢ Platform: N55 has chain, not belt</div>
                <div className="text-slate-400">‚Ä¢ Physics: Rod knock ‚àù crank speed</div>
              </div>
            </div>
          ),
          details: null
        },
        {
          n: '5', title: 'Abductive Ranking', type: 'hybrid', validation: 'unvalidated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="text-blue-400 font-semibold mb-1">LLM + RAG: "What explains ALL evidence?"</div>
              <div className="space-y-1">
                {[
                  { fault: 'Rod knock', score: '0.72', top: true },
                  { fault: 'Main bearing', score: '0.58', top: false },
                ].map((h, i) => (
                  <div key={i} className={`flex justify-between p-1 rounded ${h.top ? 'bg-blue-900/30' : 'bg-slate-900'}`}>
                    <span className={h.top ? 'text-white' : 'text-slate-400'}>{h.fault}</span>
                    <span className={h.top ? 'text-green-400' : 'text-slate-500'}>{h.score}</span>
                  </div>
                ))}
              </div>
            </div>
          ),
          details: (
            <div className="text-xs text-slate-300 space-y-2">
              <div className="bg-slate-900 rounded p-2">
                <div className="text-slate-400 mb-1">Hallucination mitigation:</div>
                <div>‚Ä¢ RAG grounding in repair manuals</div>
                <div>‚Ä¢ Role-Rule-Format prompting</div>
                <div>‚Ä¢ Symbolic verification against Stage 4</div>
              </div>
              <div className="text-slate-500">LLM: Cloud API or Qwen2.5-7B on-device (TBD)</div>
            </div>
          )
        },
        {
          n: '6', title: 'Hierarchical Fallback', type: 'symbolic', validation: 'unvalidated',
          content: (
            <div className="bg-slate-800 rounded p-2 text-xs">
              <div className="flex items-center gap-2 justify-center">
                <span className="text-green-400">rod_knock</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-yellow-400">bottom_end</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-orange-400">engine</span>
                <span className="text-slate-500">‚Üí</span>
                <span className="text-red-400">mechanic</span>
              </div>
            </div>
          ),
          details: null
        },
        {
          n: '7', title: 'Output', type: 'hybrid', validation: 'unvalidated',
          content: (
            <div className="bg-gradient-to-r from-slate-800 to-slate-900 rounded p-3 border border-blue-500/50 text-xs">
              <div className="flex justify-between items-center mb-2">
                <span className="text-white font-bold">üîß Rod Bearing Wear</span>
                <span className="bg-blue-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">72%</span>
              </div>
              <div className="grid grid-cols-2 gap-2 text-slate-300">
                <div><span className="text-green-400">‚úì</span> Vibration: crank corr 0.94</div>
                <div><span className="text-yellow-400">‚ö†</span> Oil pressure: normal</div>
              </div>
            </div>
          ),
          details: null
        },
      ];

      return (
        <div className="space-y-2">
          {stages.map((s, i) => (
            <div key={i}>
              <div className="bg-slate-900/50 rounded-lg border border-slate-700 overflow-hidden">
                <div className="p-3">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center gap-2">
                      <span className="bg-slate-700 text-slate-300 text-xs font-bold w-6 h-6 rounded flex items-center justify-center">{s.n}</span>
                      <span className="text-blue-400 text-sm font-semibold">{s.title}</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <TypeBadge type={s.type} />
                      <ValidationBadge status={s.validation} />
                    </div>
                  </div>
                  {s.content}
                </div>
                {s.details && (
                  <>
                    <button
                      onClick={() => setExpanded(expanded === i ? null : i)}
                      className="w-full px-3 py-1.5 bg-slate-800/50 border-t border-slate-700 flex items-center justify-between text-xs text-slate-500 hover:bg-slate-800"
                    >
                      <span>Details</span>
                      <span>{expanded === i ? '‚àí' : '+'}</span>
                    </button>
                    {expanded === i && (
                      <div className="px-3 py-2 bg-slate-800/30 border-t border-slate-700">
                        {s.details}
                      </div>
                    )}
                  </>
                )}
              </div>
              {i < stages.length - 1 && <Arrow />}
            </div>
          ))}
        </div>
      );
    };

    // Research Log - Moved open questions here
    const ResearchLog = () => {
      const items = [
        { stage: '1', q: 'Accelerometer placement: engine block vs. chassis vs. multiple?', status: 'resolved', answer: 'Dual: valve cover + oil pan' },
        { stage: '1', q: 'Sampling rate: 10kHz or 50kHz?', status: 'resolved', answer: '50kHz for bearing faults' },
        { stage: '1', q: 'Audio value-add vs. vibration alone?', status: 'resolved', answer: 'Minimal. AST underperformed. Demoted.' },
        { stage: '2', q: 'WSST vs WST vs FFT?', status: 'resolved', answer: 'FFT sufficient for stable RPM (85.6%). WSST for variable.' },
        { stage: '2', q: 'Best feature type for vibration?', status: 'resolved', answer: 'Mel-spectrogram > MFCC > classical FFT' },
        { stage: '2', q: 'Best classifier for MAFAULDA?', status: 'resolved', answer: 'MLP (98.72%) ‚âà SVM > RF > LR' },
        { stage: '2', q: 'Sensor fusion value?', status: 'resolved', answer: 'Only +0.25% gain. Not worth complexity.' },
        { stage: '2b', q: 'OBD simulation realistic?', status: 'resolved', answer: 'Yes. 69.6% vs 74.1% real (EngineFaultDB)' },
        { stage: '2b', q: 'Synthetic fault signatures valid?', status: 'resolved', answer: 'Confusion patterns match real data' },
        { stage: '2', q: 'Paderborn AST embeddings?', status: 'resolved', answer: 'Poor clustering. Domain gap too large.' },
        { stage: '2', q: 'Fusion weighting: static or learned attention?', status: 'open', answer: null },
        { stage: '3', q: 'Graph storage: Neo4j vs in-memory?', status: 'open', answer: null },
        { stage: '3', q: 'KG population: manual vs LLM extraction?', status: 'open', answer: null },
        { stage: '5', q: 'LLM: cloud API vs on-device SLM?', status: 'open', answer: null },
        { stage: '5', q: 'Confidence calibration method?', status: 'open', answer: null },
      ];

      return (
        <div className="space-y-2">
          {items.map((item, i) => (
            <div key={i} className={`rounded p-2 text-xs ${item.status === 'resolved' ? 'bg-green-900/20 border border-green-500/30' : 'bg-slate-800'}`}>
              <div className="flex items-start gap-2">
                <span className="bg-slate-700 text-slate-400 px-1.5 py-0.5 rounded text-xs">S{item.stage}</span>
                <div className="flex-1">
                  <div className={item.status === 'resolved' ? 'text-slate-400 line-through' : 'text-slate-300'}>{item.q}</div>
                  {item.answer && <div className="text-green-400 mt-1">‚Üí {item.answer}</div>}
                </div>
                <span className={`px-1.5 py-0.5 rounded text-xs ${item.status === 'resolved' ? 'bg-green-500/20 text-green-400' : 'bg-yellow-500/20 text-yellow-400'}`}>
                  {item.status}
                </span>
              </div>
            </div>
          ))}
        </div>
      );
    };

    function Pipeline() {
      const [view, setView] = useState('executive');

      return (
        <div className="min-h-screen bg-gradient-to-br from-slate-950 to-slate-900 p-4">
          <h1 className="text-xl font-bold text-center mb-1 bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">
            Vehicle Diagnostic Pipeline v3.3
          </h1>
          <p className="text-center text-slate-500 text-xs mb-4">Neuro-Symbolic Architecture</p>

          {/* View Toggle */}
          <div className="flex justify-center gap-1 mb-4">
            {['executive', 'engineering', 'research'].map(v => (
              <button
                key={v}
                onClick={() => setView(v)}
                className={`px-3 py-1 rounded text-xs font-medium transition ${
                  view === v ? 'bg-blue-500 text-white' : 'bg-slate-800 text-slate-400 hover:bg-slate-700'
                }`}
              >
                {v.charAt(0).toUpperCase() + v.slice(1)}
              </button>
            ))}
          </div>

          {/* Validation Summary */}
          <div className="max-w-2xl mx-auto mb-4 flex justify-center gap-4 text-xs">
            <div className="flex items-center gap-1">
              <span className="text-green-400">‚óè</span>
              <span className="text-slate-400">3/8 validated</span>
            </div>
            <div className="flex items-center gap-1">
              <span className="text-slate-400">‚óè</span>
              <span className="text-slate-400">5/8 pending</span>
            </div>
          </div>

          <div className="max-w-2xl mx-auto">
            {view === 'executive' && <ExecutiveView />}
            {view === 'engineering' && <EngineeringView />}
            {view === 'research' && <ResearchLog />}
          </div>

          {/* Compact Legend */}
          <div className="max-w-2xl mx-auto mt-4 pt-3 border-t border-slate-800 flex justify-center gap-4 text-xs text-slate-500">
            <span><span className="text-purple-400">‚ñ†</span> Neural</span>
            <span><span className="text-green-400">‚ñ†</span> Symbolic</span>
            <span><span className="text-blue-400">‚ñ†</span> Hybrid</span>
          </div>

          <div className="text-center text-xs text-slate-600 mt-3">
            v3.3 ‚Äî MAFAULDA validated (98.7%), OBD sim validated vs EngineFaultDB (Œî5%), Audio demoted
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<Pipeline />);
  </script>
</body>
</html>
